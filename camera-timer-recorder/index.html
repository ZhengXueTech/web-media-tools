<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ„å½±è¨ˆæ™‚å™¨</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .setup-section {
            margin-bottom: 30px;
        }
        
        .input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        label {
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            width: 80px;
            text-align: center;
            transition: border-color 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }
        
        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            margin: 0 10px;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        
        .stop-btn {
            background: linear-gradient(45deg, #f44336, #da190b);
            color: white;
        }
        
        .stop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .timer-display {
            font-size: 4em;
            font-weight: bold;
            margin: 30px 0;
            color: #333;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .status {
            font-size: 1.3em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 20px;
        }
        
        .status.waiting {
            background: linear-gradient(45deg, #e3f2fd, #bbdefb);
            color: #1976d2;
            border: 2px solid #2196f3;
        }
        
        .status.preparing {
            background: linear-gradient(45deg, #fff3e0, #ffcc02);
            color: #f57c00;
            border: 2px solid #ff9800;
            animation: pulse 1s infinite;
        }
        
        .status.recording {
            background: linear-gradient(45deg, #ffebee, #ef5350);
            color: #c62828;
            border: 2px solid #f44336;
            animation: pulse 1s infinite;
        }
        
        .status.finished {
            background: linear-gradient(45deg, #e8f5e8, #4caf50);
            color: #2e7d32;
            border: 2px solid #4caf50;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .video-container {
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            background: #000;
            min-height: 300px;
        }
        
        canvas {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            background: #000;
            min-height: 300px;
        }
        
        .recording-indicator {
            display: none;
            background: #f44336;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 10px;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .download-section {
            margin-top: 20px;
        }
        
        .download-btn {
            background: linear-gradient(45deg, #2196f3, #0d47a1);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }
        
        .error {
            color: #f44336;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ éŒ„å½±è¨ˆæ™‚å™¨</h1>
        
        <div class="setup-section">
            <div class="input-group">
                <label for="minutes">åˆ†é˜:</label>
                <input type="number" id="minutes" min="0" max="10" value="1">
                
                <label for="seconds">ç§’é˜:</label>
                <input type="number" id="seconds" min="0" max="59" value="0">
            </div>
            
            <div class="input-group">
                <label for="showTimer">
                    <input type="checkbox" id="showTimer" checked>
                    åœ¨éŒ„å½±ä¸­é¡¯ç¤ºå€’æ•¸æ•¸å­—
                </label>
            </div>
            
            <button class="start-btn" id="startBtn" onclick="startTimer()" disabled>åˆå§‹åŒ–æ”åƒé ­ä¸­...</button>
            <button class="stop-btn" id="stopBtn" onclick="stopRecording()" style="display: none;">åœæ­¢éŒ„å½±</button>
        </div>
        
        <div class="timer-display" id="timerDisplay">00:00</div>
        
        <div class="status waiting" id="status">æ­£åœ¨åˆå§‹åŒ–æ”åƒé ­...</div>
        
        <div class="recording-indicator" id="recordingIndicator">ğŸ”´ éŒ„å½±ä¸­</div>
        
        <div class="video-container">
            <video id="video" autoplay muted playsinline controls></video>
            <canvas id="recordingCanvas" style="display: none;"></canvas>
        </div>
        
        <div class="download-section" id="downloadSection" style="display: none;">
            <div id="downloadButtons"></div>
            <div id="conversionStatus" style="margin-top: 10px; font-weight: bold;"></div>
            <canvas id="conversionCanvas" style="display: none;"></canvas>
        </div>
        
        <div class="error" id="error" style="display: none;"></div>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let timerInterval;
        let currentPhase = 'waiting'; // waiting, preparing, timing, extending, finished
        let totalSeconds = 0;
        let remainingSeconds = 0;
        let isRecording = false;
        let showTimerInVideo = true;
        let recordingCanvas, recordingContext;
        let animationId;

        // åˆå§‹åŒ–æ”åƒé ­
        async function initCamera() {
            try {
                // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ç€è¦½å™¨ä¸æ”¯æ´æ”åƒé ­åŠŸèƒ½');
                }

                updateStatus('æ­£åœ¨è«‹æ±‚æ”åƒé ­æ¬Šé™...', 'preparing');
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // ç¢ºä¿è¦–é »é–‹å§‹æ’­æ”¾
                video.onloadedmetadata = () => {
                    video.play().then(() => {
                        console.log('è¦–é »é–‹å§‹æ’­æ”¾');
                        document.getElementById('error').style.display = 'none';
                        updateStatus('æ”åƒé ­å·²æº–å‚™å°±ç·’', 'waiting');
                        
                        // å•Ÿç”¨é–‹å§‹æŒ‰éˆ•
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').textContent = 'é–‹å§‹è¨ˆæ™‚éŒ„å½±';
                    }).catch(err => {
                        console.error('è¦–é »æ’­æ”¾å¤±æ•—:', err);
                        showError('è¦–é »æ’­æ”¾å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                    });
                };
                
            } catch (err) {
                console.error('ç„¡æ³•è¨ªå•æ”åƒé ­:', err);
                let errorMessage = '';
                
                switch(err.name) {
                    case 'NotAllowedError':
                        errorMessage = 'æ”åƒé ­æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹é»æ“Šç€è¦½å™¨ç¶²å€åˆ—æ—çš„æ”åƒé ­åœ–ç¤ºï¼Œé¸æ“‡ã€Œå…è¨±ã€ï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ã€‚';
                        break;
                    case 'NotFoundError':
                        errorMessage = 'æ‰¾ä¸åˆ°æ”åƒé ­è¨­å‚™ï¼Œè«‹ç¢ºä¿æ”åƒé ­å·²é€£æ¥ã€‚';
                        break;
                    case 'NotReadableError':
                        errorMessage = 'æ”åƒé ­è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½”ç”¨ï¼Œè«‹é—œé–‰å…¶ä»–ä½¿ç”¨æ”åƒé ­çš„ç¨‹å¼ã€‚';
                        break;
                    case 'OverconstrainedError':
                        errorMessage = 'æ”åƒé ­è¨­å®šä¸ç¬¦åˆè¦æ±‚ï¼Œæ­£åœ¨å˜—è©¦é™ä½å“è³ª...';
                        // å˜—è©¦è¼ƒä½çš„è§£æåº¦
                        setTimeout(() => initCameraLowRes(), 1000);
                        return;
                    default:
                        errorMessage = `æ”åƒé ­åˆå§‹åŒ–å¤±æ•—: ${err.message}`;
                }
                
                showError(errorMessage);
                updateStatus('æ”åƒé ­æœªå°±ç·’', 'waiting');
                document.getElementById('startBtn').disabled = true;
            }
        }

        // å˜—è©¦è¼ƒä½è§£æåº¦
        async function initCameraLowRes() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: true
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play().then(() => {
                        console.log('è¦–é »é–‹å§‹æ’­æ”¾ (ä½è§£æåº¦)');
                        document.getElementById('error').style.display = 'none';
                        updateStatus('æ”åƒé ­å·²æº–å‚™å°±ç·’ (é™ä½å“è³ª)', 'waiting');
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').textContent = 'é–‹å§‹è¨ˆæ™‚éŒ„å½±';
                    }).catch(err => {
                        console.error('è¦–é »æ’­æ”¾å¤±æ•—:', err);
                        showError('è¦–é »æ’­æ”¾å¤±æ•—');
                    });
                };
                
            } catch (err) {
                showError('ç„¡æ³•å•Ÿå‹•æ”åƒé ­ï¼Œè«‹æª¢æŸ¥è¨­å‚™å’Œæ¬Šé™è¨­å®š');
                updateStatus('æ”åƒé ­æœªå°±ç·’', 'waiting');
            }
        }

        function showError(message) {
            console.error('éŒ¯èª¤:', message);
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function updateStatus(message, className) {
            console.log('ç‹€æ…‹æ›´æ–°:', message, className);
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${className}`;
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            
            document.getElementById('timerDisplay').textContent = timeString;
            
            // ä¸å†ä½¿ç”¨é è¦½æ™‚çš„è¦–é »è¦†è“‹å±¤
        }

        function startTimer() {
            const minutes = parseInt(document.getElementById('minutes').value) || 0;
            const seconds = parseInt(document.getElementById('seconds').value) || 0;
            showTimerInVideo = document.getElementById('showTimer').checked;
            
            totalSeconds = minutes * 60 + seconds;
            
            if (totalSeconds <= 0 || totalSeconds > 600) {
                showError('è«‹è¨­å®š1ç§’åˆ°10åˆ†é˜ä¹‹é–“çš„æ™‚é–“');
                return;
            }

            if (!stream) {
                showError('æ”åƒé ­æœªæº–å‚™å¥½ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥æ”åƒé ­æ¬Šé™');
                return;
            }

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('startBtn').textContent = 'é–‹å§‹è¨ˆæ™‚éŒ„å½±';

            // åˆå§‹åŒ–éŒ„å½±ç•«å¸ƒ
            if (showTimerInVideo) {
                setupRecordingCanvas();
            }

            // é–‹å§‹é å‚™å€’æ•¸ï¼ˆ10ç§’ï¼‰
            currentPhase = 'preparing';
            remainingSeconds = 10;
            updateStatus('é å‚™å€’æ•¸', 'preparing');
            updateTimerDisplay(remainingSeconds);

            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay(remainingSeconds);

                if (currentPhase === 'preparing') {
                    if (remainingSeconds === 5) {
                        // é–‹å§‹éŒ„å½±ï¼ˆé å‚™å€’æ•¸5ç§’æ™‚ï¼‰
                        startRecording();
                    }
                    
                    if (remainingSeconds <= 0) {
                        // é€²å…¥æ­£å¼è¨ˆæ™‚
                        currentPhase = 'timing';
                        remainingSeconds = totalSeconds;
                        updateStatus('æ­£åœ¨è¨ˆæ™‚éŒ„å½±', 'recording');
                    }
                } else if (currentPhase === 'timing') {
                    if (remainingSeconds <= 0) {
                        // é€²å…¥å»¶é²éšæ®µï¼ˆç¹¼çºŒéŒ„å½±10ç§’ï¼‰
                        currentPhase = 'extending';
                        remainingSeconds = 10;
                        updateStatus('å»¶é•·éŒ„å½±ä¸­', 'recording');
                        updateTimerDisplay(0); // é¡¯ç¤º00:00
                    }
                } else if (currentPhase === 'extending') {
                    if (remainingSeconds <= 0) {
                        // çµæŸéŒ„å½±
                        finishRecording();
                    }
                }
            }, 1000);
        }

        function setupRecordingCanvas() {
            recordingCanvas = document.getElementById('recordingCanvas');
            recordingContext = recordingCanvas.getContext('2d');
            
            const video = document.getElementById('video');
            
            // ç­‰å¾…è¦–é »å…ƒæ•¸æ“šè¼‰å…¥
            if (video.videoWidth && video.videoHeight) {
                recordingCanvas.width = video.videoWidth;
                recordingCanvas.height = video.videoHeight;
            } else {
                // ä½¿ç”¨é è¨­è§£æåº¦
                recordingCanvas.width = 640;
                recordingCanvas.height = 480;
            }
            
            console.log('Canvaså°ºå¯¸:', recordingCanvas.width, 'x', recordingCanvas.height);
            
            recordingCanvas.style.display = 'block';
            video.style.display = 'none';
        }

        function drawVideoWithTimer() {
            if (!isRecording || !showTimerInVideo || !recordingContext) return;
            
            const video = document.getElementById('video');
            const canvas = recordingCanvas;
            const ctx = recordingContext;
            
            // ç¢ºä¿è¦–é »æ­£åœ¨æ’­æ”¾
            if (video.readyState >= video.HAVE_CURRENT_DATA) {
                // æ¸…é™¤ç•«å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç¹ªè£½è¦–é »ç•«é¢
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // è¨ˆç®—ç•¶å‰é¡¯ç¤ºçš„æ™‚é–“
                let displaySeconds;
                if (currentPhase === 'preparing') {
                    displaySeconds = remainingSeconds; // é å‚™å€’æ•¸
                } else if (currentPhase === 'timing') {
                    displaySeconds = remainingSeconds; // æ­£å¼è¨ˆæ™‚
                } else if (currentPhase === 'extending') {
                    displaySeconds = 0; // å»¶é•·éšæ®µé¡¯ç¤º00:00
                } else {
                    displaySeconds = 0;
                }
                
                const minutes = Math.floor(displaySeconds / 60);
                const secs = displaySeconds % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                
                // è¨­å®šæ–‡å­—æ¨£å¼
                const fontSize = Math.max(24, canvas.width / 20); // éŸ¿æ‡‰å¼å­—é«”å¤§å°
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'top';
                
                // è¨ˆç®—æ–‡å­—ä½ç½®ï¼ˆå³ä¸Šè§’ï¼‰
                const padding = 20;
                const x = canvas.width - padding;
                const y = padding;
                
                // æ¸¬é‡æ–‡å­—å°ºå¯¸
                const textMetrics = ctx.measureText(timeString);
                const textWidth = textMetrics.width;
                const textHeight = fontSize;
                
                // ç¹ªè£½åŠé€æ˜èƒŒæ™¯
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(x - textWidth - 10, y - 5, textWidth + 20, textHeight + 10);
                
                // ç¹ªè£½ç™½è‰²é‚Šæ¡†
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.strokeRect(x - textWidth - 10, y - 5, textWidth + 20, textHeight + 10);
                
                // ç¹ªè£½æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.fillText(timeString, x, y);
                
                console.log('ç¹ªè£½è¨ˆæ™‚å™¨:', timeString, 'ä½ç½®:', x, y);
            }
            
            // ç¹¼çºŒå‹•ç•«
            if (isRecording && showTimerInVideo) {
                animationId = requestAnimationFrame(drawVideoWithTimer);
            }
        }

        function startRecording() {
            try {
                recordedChunks = [];
                
                let recordingStream;
                
                if (showTimerInVideo) {
                    console.log('å•Ÿå‹•å¸¶è¨ˆæ™‚å™¨çš„éŒ„å½±æ¨¡å¼');
                    
                    // ç¢ºä¿Canvasæº–å‚™å°±ç·’
                    setTimeout(() => {
                        drawVideoWithTimer();
                    }, 100);
                    
                    // ä½¿ç”¨è¼ƒé«˜çš„å¹€ç‡ä¾†ç¢ºä¿æµæš¢åº¦
                    recordingStream = recordingCanvas.captureStream(60);
                    
                    // æ·»åŠ éŸ³é »è»Œé“
                    const audioTracks = stream.getAudioTracks();
                    if (audioTracks.length > 0) {
                        recordingStream.addTrack(audioTracks[0]);
                        console.log('å·²æ·»åŠ éŸ³é »è»Œé“');
                    }
                    
                    console.log('éŒ„å½±æµè»Œé“æ•¸é‡:', recordingStream.getTracks().length);
                } else {
                    console.log('å•Ÿå‹•æ™®é€šéŒ„å½±æ¨¡å¼');
                    recordingStream = stream;
                }
                
                // å˜—è©¦ä¸åŒçš„ç·¨ç¢¼æ ¼å¼ï¼Œå„ªå…ˆé¸æ“‡å“è³ªè¼ƒå¥½çš„
                let options = { videoBitsPerSecond: 2500000 }; // 2.5 Mbps
                
                if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus')) {
                    options.mimeType = 'video/webm;codecs=vp9,opus';
                    console.log('ä½¿ç”¨ VP9 ç·¨ç¢¼');
                } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus')) {
                    options.mimeType = 'video/webm;codecs=vp8,opus';
                    console.log('ä½¿ç”¨ VP8 ç·¨ç¢¼');
                } else if (MediaRecorder.isTypeSupported('video/mp4')) {
                    options.mimeType = 'video/mp4';
                    console.log('ä½¿ç”¨ MP4 ç·¨ç¢¼');
                } else {
                    console.log('ä½¿ç”¨é è¨­ç·¨ç¢¼');
                }
                
                mediaRecorder = new MediaRecorder(recordingStream, options);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log('éŒ„è£½æ•¸æ“šå¡Šå¤§å°:', event.data.size);
                    }
                };

                mediaRecorder.onstop = () => {
                    console.log('éŒ„å½±åœæ­¢ï¼Œç¸½æ•¸æ“šå¡Š:', recordedChunks.length);
                    
                    const mimeType = mediaRecorder.mimeType || 'video/webm';
                    const blob = new Blob(recordedChunks, { type: mimeType });
                    
                    console.log('æœ€çµ‚å½±ç‰‡å¤§å°:', blob.size, 'bytes');
                    
                    window.recordedBlob = blob;
                    window.recordedMimeType = mimeType;
                    
                    // å‰µå»ºé è¦½
                    const url = URL.createObjectURL(blob);
                    window.recordedVideoUrl = url;
                    
                    document.getElementById('downloadSection').style.display = 'block';
                    
                    // å¦‚æœæ”¯æ´ MP4ï¼Œç›´æ¥æä¾› MP4 ä¸‹è¼‰
                    if (mimeType.includes('mp4')) {
                        updateDownloadButtons('mp4');
                    } else {
                        // å¦å‰‡æä¾›è½‰æ›é¸é …
                        updateDownloadButtons('webm');
                    }
                };

                // å®šæœŸéŒ„è£½æ•¸æ“šä»¥ç¢ºä¿ä¸ä¸Ÿå¤±
                mediaRecorder.start(1000); // æ¯ç§’éŒ„è£½ä¸€æ¬¡
                isRecording = true;
                document.getElementById('recordingIndicator').style.display = 'inline-block';
                
                console.log('MediaRecorder å·²å•Ÿå‹•');
                
            } catch (err) {
                console.error('éŒ„å½±å•Ÿå‹•å¤±æ•—:', err);
                showError('éŒ„å½±å•Ÿå‹•å¤±æ•—: ' + err.message);
            }
        }

        function stopRecording() {
            clearInterval(timerInterval);
            
            if (isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            finishRecording();
        }

        function stopRecording() {
            console.log('æ‰‹å‹•åœæ­¢éŒ„å½±');
            clearInterval(timerInterval);
            
            if (isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            finishRecording();
        }

        function finishRecording() {
            console.log('å®ŒæˆéŒ„å½±æµç¨‹');
            clearInterval(timerInterval);
            
            if (isRecording && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            isRecording = false;
            currentPhase = 'finished';
            
            // åœæ­¢å‹•ç•«
            if (animationId) {
                cancelAnimationFrame(animationId);
                console.log('å·²åœæ­¢å‹•ç•«å¹€');
            }
            
            // æ¢å¾©è¦–é »é¡¯ç¤º
            const video = document.getElementById('video');
            const canvas = document.getElementById('recordingCanvas');
            
            setTimeout(() => {
                video.style.display = 'block';
                canvas.style.display = 'none';
                console.log('å·²æ¢å¾©è¦–é »é¡¯ç¤º');
            }, 500); // å»¶é²æ¢å¾©ï¼Œç¢ºä¿éŒ„å½±å®Œå…¨åœæ­¢
            
            document.getElementById('recordingIndicator').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            
            updateStatus('éŒ„å½±å®Œæˆï¼', 'finished');
        }

        function updateDownloadButtons(format) {
            const downloadButtons = document.getElementById('downloadButtons');
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
            
            if (format === 'mp4') {
                downloadButtons.innerHTML = `
                    <button class="download-btn" onclick="downloadVideo('mp4')">ä¸‹è¼‰ MP4</button>
                `;
            } else {
                downloadButtons.innerHTML = `
                    <button class="download-btn" onclick="downloadVideo('webm')">ä¸‹è¼‰ WebM (åŸå§‹)</button>
                    <button class="download-btn" onclick="convertToMp4()" style="margin-left: 10px;">è½‰æ›ä¸¦ä¸‹è¼‰ MP4</button>
                `;
            }
        }

        function downloadVideo(format) {
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
            
            if (window.recordedVideoUrl) {
                const a = document.createElement('a');
                a.href = window.recordedVideoUrl;
                
                if (format === 'mp4') {
                    a.download = `recording_${timestamp}.mp4`;
                } else {
                    a.download = `recording_${timestamp}.webm`;
                }
                
                a.click();
            }
        }

        // ä½¿ç”¨ Canvas é€²è¡Œæ ¼å¼è½‰æ›
        async function convertToMp4() {
            if (!window.recordedBlob) {
                showError('æ²’æœ‰å¯è½‰æ›çš„éŒ„å½±');
                return;
            }

            const conversionStatus = document.getElementById('conversionStatus');
            conversionStatus.textContent = 'æ­£åœ¨è½‰æ›ç‚º MP4...';
            conversionStatus.style.color = '#f57c00';

            try {
                // å‰µå»ºè¦–é »å…ƒç´ ä¾†æ’­æ”¾éŒ„è£½çš„å…§å®¹
                const videoElement = document.createElement('video');
                videoElement.src = window.recordedVideoUrl;
                videoElement.muted = true;
                videoElement.preload = 'metadata';

                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = resolve;
                });

                const canvas = document.getElementById('conversionCanvas');
                const ctx = canvas.getContext('2d');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;

                // ä½¿ç”¨ MediaRecorder é‡æ–°éŒ„è£½ç‚º MP4ï¼ˆå¦‚æœæ”¯æ´ï¼‰
                const canvasStream = canvas.captureStream();
                
                let mp4Options = {};
                if (MediaRecorder.isTypeSupported('video/mp4;codecs=avc1')) {
                    mp4Options = { mimeType: 'video/mp4;codecs=avc1' };
                } else if (MediaRecorder.isTypeSupported('video/mp4')) {
                    mp4Options = { mimeType: 'video/mp4' };
                } else {
                    // å¦‚æœä¸æ”¯æ´ MP4ï¼Œä½¿ç”¨è¼ƒç›¸å®¹çš„æ ¼å¼
                    conversionStatus.textContent = 'ç€è¦½å™¨ä¸æ”¯æ´ MP4 è½‰æ›ï¼Œå°‡ä¸‹è¼‰ WebM æ ¼å¼';
                    conversionStatus.style.color = '#f44336';
                    setTimeout(() => downloadVideo('webm'), 2000);
                    return;
                }

                const mp4Recorder = new MediaRecorder(canvasStream, mp4Options);
                const mp4Chunks = [];

                mp4Recorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        mp4Chunks.push(event.data);
                    }
                };

                mp4Recorder.onstop = () => {
                    const mp4Blob = new Blob(mp4Chunks, { type: 'video/mp4' });
                    const mp4Url = URL.createObjectURL(mp4Blob);
                    
                    const a = document.createElement('a');
                    a.href = mp4Url;
                    a.download = `recording_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.mp4`;
                    a.click();
                    
                    conversionStatus.textContent = 'MP4 è½‰æ›å®Œæˆï¼';
                    conversionStatus.style.color = '#4caf50';
                    
                    // æ¸…ç†
                    URL.revokeObjectURL(mp4Url);
                };

                mp4Recorder.start();

                // æ’­æ”¾åŸè¦–é »ä¸¦ç¹ªè£½åˆ° Canvas
                videoElement.currentTime = 0;
                videoElement.play();

                const drawFrame = () => {
                    if (videoElement.ended) {
                        mp4Recorder.stop();
                        return;
                    }
                    
                    ctx.drawImage(videoElement, 0, 0);
                    requestAnimationFrame(drawFrame);
                };

                videoElement.onplay = () => {
                    drawFrame();
                };

            } catch (err) {
                console.error('è½‰æ›å¤±æ•—:', err);
                conversionStatus.textContent = 'è½‰æ›å¤±æ•—ï¼Œå°‡ä¸‹è¼‰åŸå§‹ WebM æ ¼å¼';
                conversionStatus.style.color = '#f44336';
                setTimeout(() => downloadVideo('webm'), 2000);
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–æ”åƒé ­
        window.onload = () => {
            console.log('é é¢è¼‰å…¥ï¼Œé–‹å§‹åˆå§‹åŒ–æ”åƒé ­');
            initCamera();
        };

        // é é¢é—œé–‰æ™‚æ¸…ç†è³‡æº
        window.onbeforeunload = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        };
    </script>
</body>
</html>